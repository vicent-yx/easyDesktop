<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>easyDesktop</title>
    <link rel="stylesheet" href="/resources/all.min.css">
    <link rel="stylesheet" id="theme_css" href="/theme/dark.css"> 
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="time-display">
                <i class="fas fa-clock"></i>
                <span id="current-time">loading...</span>
            </div>
            <div class="path-navigation">
                <button id="pathBackBtn" class="path-btn"><i class="fas fa-arrow-up"></i></button>
                <div class="breadcrumb" id="breadcrumb">
                    <span id="b2d" class="breadcrumb-item" data-path="">桌面</span>
                </div>
                <div class="search_box"id="search_box">
                    <input id="search_input" oninput="load_search()" class="search_input" type="text" placeholder="搜索...">
                </div>
            </div>
            <div class="view-toggle">
                <button id="gridViewBtn" class="view-btn active"><i class="fas fa-th-large"></i></button>
                <button id="listViewBtn" class="view-btn"><i class="fas fa-list"></i></button>
            </div>
            <button id="settingsBtn" class="settings-btn"><i class="fas fa-cog"></i></button>
        </div>

        <div class="files-grid" id="filesContainer">
            <!-- 网格视图内容 -->
        </div>
        <div class="files-list" id="filesListContainer" style="display:none;">
            <!-- 列表视图内容 -->
        </div>
            <!-- 文件项将通过JavaScript动态生成 -->
        </div>

        <!-- 右键菜单 -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" id="menuOpen">
                <i class="fas fa-folder-open"></i>
                <span>打开</span>
            </div>
            <div class="context-menu-item" id="menuCopy">
                <i class="fas fa-copy"></i>
                <span>复制</span>
            </div>
            <div class="context-menu-item" id="menuRename">
                <i class="fas fa-edit"></i>
                <span>重命名</span>
            </div>
            <div class="context-menu-item delete" id="menuDelete">
                <i class="fas fa-trash-alt"></i>
                <span>删除</span>
            </div>
        </div>
        <div class="context-menu" id="blankMenu">
            <div class="context-menu-item" id="menuPaste">
                <i class="fas fa-paste"></i>
                <span>粘贴</span>
            </div>
            <div class="context-menu-item" id="menuNew">
                <i class="fas fa-plus"></i>
                <span>新建</span>
            </div>
        </div>

        <!-- 重命名对话框 -->
        <div class="rename-overlay" id="renameOverlay">
            <div class="rename-container">
                <h3>重命名文件</h3>
                <input type="text" class="rename-input" id="renameInput" placeholder="输入新文件名">
                <div class="rename-buttons">
                    <button class="rename-btn cancel" id="renameCancel">取消</button>
                    <button class="rename-btn confirm" id="renameConfirm">确认</button>
                </div>
            </div>
        </div>

        <!-- 删除确认对话框 -->
        <div class="delete-confirm" id="deleteConfirm">
            <div class="delete-container">
                <h3>确认删除</h3>
                <p>您确定要删除文件 "<span id="deleteFileName"></span>" 吗？此操作不可恢复。</p>
                <div class="delete-buttons">
                    <button class="delete-btn cancel" id="deleteCancel">取消</button>
                    <button class="delete-btn confirm" id="deleteConfirmBtn">确认删除</button>
                </div>
            </div>
        </div>

        <!-- 新建文件对话框 -->
        <div class="rename-overlay" id="newFileOverlay">
            <div class="rename-container">
                <h3>新建文件</h3>
                <select id="newFileTypeSelect" class="rename-input">
                    <option value="docx">Word 文档 (.docx)</option>
                    <option value="xlsx">Excel 表格 (.xlsx)</option>
                    <option value="pptx">PPT 演示 (.pptx)</option>
                    <option value="txt">文本文件 (.txt)</option>
                    <option value="folder">文件夹</option>
                </select>
                <div class="rename-buttons">
                    <button class="rename-btn cancel" id="newFileCancel">取消</button>
                    <button class="rename-btn confirm" id="newFileConfirm">确认</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const blankMenu = document.getElementById('blankMenu');
        const newFileOverlay = document.getElementById('newFileOverlay');
        const newFileTypeSelect = document.getElementById('newFileTypeSelect');
        const newFileCancel = document.getElementById('newFileCancel');
        const newFileConfirm = document.getElementById('newFileConfirm');
        const menuPaste = document.getElementById('menuPaste');
        const menuNew = document.getElementById('menuNew');
        const scripts_type=[".py",".java",".c",".cpp",".h",".hpp",".cs",".php",".rb",".go",".swift",".kt",".m",".pl",".r",".sh",".bash",".zsh",".lua",".scala",".groovy",".dart",".rs",".jl",".hs",".f",".f90",".f95",".v",".vhd",".clj",".ex",".exs",".elm",".purs",".erl",".hrl",".fs",".fsx",".fsi",".ml",".mli",".pas",".pp",".d",".nim",".cr",".cbl",".cob",".ada",".adb",".ads"]
        let files_data = []
        let selectedFile = null;
        let contextMenu = null;
        let dealling = false;
        let currentPath = ''; // 当前浏览路径
        let pathHistory = []; // 路径历史记录
        let currentHistoryIndex = -1; // 当前历史记录索引
        let timer = null
        
        // 获取文件类型
        function getFileType(fileName,fileType) {
            console.log('文件类型：',fileType);
            const ext = fileName.split('.').pop().toLowerCase();
            const types = {
                'docx': '文档',
                'doc': '文档',
                'xlsx': '电子表格',
                'xls': '电子表格',
                'pptx': '演示文稿',
                'ppt': '演示文稿',
                'pdf': 'PDF文件',
                'jpg': '图片',
                'png': '图片',
                'mp4': '视频',
                'mp3': '音频',
                'psd': '设计稿',
                'fig': '设计稿',
                'sql': '数据库',
                'json': '配置文件',
                'zip': '压缩文件',
                'exe': '应用程序',
            };
            if(scripts_type.includes(ext)){
                return fileType.slice(1)+'脚本文件';
            }
            if(ext in types){
                return types[ext];
            } else if(fileType == '文件夹'){
                return '文件夹';
            } else {
                console.log('未知文件类型：',fileType);
                return fileType.slice(1)+'文件';
            }
        }

        // 更新当前时间
        function updateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-time').textContent = now.toLocaleDateString('zh-CN', options);
        }
        function open_file(filePath) {
            window.pywebview.api.open_file(filePath);
        }
        function open_mhyGame(filePath,game){
            window.pywebview.api.open_mhyGame(filePath,game);
        }
        function copy_file(filePath) {
            window.pywebview.api.copy_file(filePath);
        }
        function rename_file(filePath, newName) {
            window.pywebview.api.rename_file(filePath, newName);
            push()
        }
        async function remove_file(filePath) {
            var r = await window.pywebview.api.remove_file(filePath);
            push()
            return r
        }

        // 显示右键菜单
        function showContextMenu(e, file) {
            e.preventDefault();
            blankMenu.style.display = 'none';
            selectedFile = file;
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        }

        // 隐藏右键菜单
        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        // 显示重命名对话框
        function showRenameDialog() {
            const renameOverlay = document.getElementById('renameOverlay');
            const renameInput = document.getElementById('renameInput');
            
            renameInput.value = selectedFile.fileName;
            renameOverlay.style.display = 'flex';
            renameInput.focus();
            
            hideContextMenu();
        }

        // 显示删除确认对话框
        function showDeleteConfirm() {
            const deleteConfirm = document.getElementById('deleteConfirm');
            const deleteFileName = document.getElementById('deleteFileName');
            
            deleteFileName.textContent = selectedFile.fileName;
            deleteConfirm.style.display = 'flex';
            
            hideContextMenu();
        }
        async function push(fData = null,useLoadDir = false, path = ''){
            if(fData==null){
                if(useLoadDir && path) {
                    files_data = await loadDirectory(path);
                    currentPath = path;
                } else {
                    files_data = await window.pywebview.api.get_inf("desktop");
                    console.log(files_data);
                    files_data = files_data["data"];
                }
                fData = files_data
            }
            
            const filesContainer = document.getElementById('filesContainer');
            const filesListContainer = document.getElementById('filesListContainer');
            filesContainer.innerHTML = '';
            filesListContainer.innerHTML = '';
            contextMenu = document.getElementById('contextMenu');
            
            // 渲染网格视图
            fData.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                
                const fileType = getFileType(file.file,file.fileType);
                
                fileElement.innerHTML = `
                    <img src="${file.ico}" alt="${file.fileName}" class="file-icon">
                    <span class="file-name">${file.fileName}</span>
                    <span class="file-type">${fileType}</span>
                `;
                
                // 添加点击事件
                fileElement.addEventListener('dblclick', function() {
                    clearTimeout(timer)
                    if (file.fileType === '文件夹') {
                        open_file(file.filePath);
                    } else if (file.game) {
                        open_mhyGame(file.filePath, file.game);
                    } else {
                        open_file(file.filePath);
                    }
                });
                fileElement.addEventListener('click', function() {
                    timer = setTimeout(async function(){
                        if (file.fileType === '文件夹') {
                            // 进入文件夹
                            navigateTo(file.filePath);
                        } else if (file.game) {
                            open_mhyGame(file.filePath, file.game);
                        } else {
                            open_file(file.filePath);
                        }
                    },200)
                });
                
                // 添加右键菜单事件
                fileElement.addEventListener('contextmenu', function(e) {
                    showContextMenu(e, file);
                });
                
                filesContainer.appendChild(fileElement);
            });

            // 渲染列表视图
            fData.forEach(file => {
                const listItem = document.createElement('div');
                listItem.className = 'file-list-item';
                
                const fileType = getFileType(file.file,file.fileType);
                
                listItem.innerHTML = `
                    <img src="${file.ico}" alt="${file.fileName}" class="file-list-icon">
                    <span class="file-list-name">${file.fileName}</span>
                    <span class="file-list-type">${fileType}</span>
                `;
                
                // 添加点击事件
                listItem.addEventListener('dblclick', function() {
                    clearTimeout(timer)
                    if (file.game) {
                        open_mhyGame(file.filePath, file.game);
                    } else {
                        open_file(file.filePath);
                    }
                });
                listItem.addEventListener('click', function() {
                    timer = setTimeout(async function(){
                        if (file.fileType === '文件夹') {
                            // 进入文件夹
                            navigateTo(file.filePath);
                        } else if (file.game) {
                            open_mhyGame(file.filePath, file.game);
                        } else {
                            open_file(file.filePath);
                        }
                    },200)
                });
                
                // 添加右键菜单事件
                listItem.addEventListener('contextmenu', function(e) {
                    showContextMenu(e, file);
                });
                
                filesListContainer.appendChild(listItem);
            });
        }
        // 视图切换
        document.getElementById('gridViewBtn').addEventListener('click', function() {
            document.getElementById('filesContainer').style.display = 'grid';
            document.getElementById('filesListContainer').style.display = 'none';
            document.getElementById('gridViewBtn').classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
        });

        document.getElementById('listViewBtn').addEventListener('click', function() {
            document.getElementById('filesContainer').style.display = 'none';
            document.getElementById('filesListContainer').style.display = 'block';
            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('listViewBtn').classList.add('active');
        });

        // 页面加载完成后执行
        window.addEventListener('pywebviewready',async function() {
            push(null);
            document.getElementById('pathBackBtn').addEventListener('click', async function(){
                parent_path = await window.pywebview.api.get_parent(currentPath)
                navigateTo(parent_path)
            });
            const settingsBtn = document.getElementById('settingsBtn');
            const themePanel = document.getElementById('themeSettingsPanel');
            const closeBtn = document.getElementById('closeThemePanel');
            const followSystemToggle = document.getElementById('followSystemTheme');
            const themeCards = document.querySelectorAll('.theme-card');
            
            // 切换设置面板显示
            settingsBtn.addEventListener('click', function() {
                disableScroll()
                themePanel.style.display = themePanel.style.display === 'block' ? 'none' : 'block';
            });
            
            // 关闭设置面板
            closeBtn.addEventListener('click', function() {
                enableScroll()
                themePanel.style.display = 'none';
            });
            
            // 跟随系统主题切换
            followSystemToggle.addEventListener('change', function() {
                const followSystem = this.checked;
                window.pywebview.api.update_config("follow_sys",followSystem);
                
                // 如果启用跟随系统，禁用主题选择
                themeCards.forEach(card => {
                    card.style.opacity = followSystem ? '0.5' : '1';
                    card.style.pointerEvents = followSystem ? 'none' : 'auto';
                });
            });
            
            // 主题卡片点击事件
            themeCards.forEach(card => {
                card.addEventListener('click', function() {
                    if (followSystemToggle.checked) return;
                    
                    const theme = this.dataset.theme;
                    window.pywebview.api.update_config("theme",theme);
                    load_theme(theme);
                    
                    // 更新选中状态
                    themeCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 初始化面板状态
            function updateUIFromConfig(config) {
                // 处理跟随系统主题
                const followSystem = config.follow_sys || false;
                followSystemToggle.checked = followSystem;
                
                // 处理主题选择
                const currentTheme = config.theme || 'dark';
                
                // 清除所有主题卡片的active状态
                themeCards.forEach(card => card.classList.remove('active'));
                
                // 设置当前主题的active状态
                if (!followSystem) {
                    document.querySelector(`.theme-card[data-theme="${currentTheme}"]`).classList.add('active');
                }
                
                // 更新主题卡片交互状态
                themeCards.forEach(card => {
                    card.style.opacity = followSystem ? '0.5' : '1';
                    card.style.pointerEvents = followSystem ? 'none' : 'auto';
                });
                
                // 如果跟随系统主题，加载系统主题
                if (followSystem) {
                    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    load_theme(systemTheme);
                } else {
                    // 否则加载配置中的主题
                    load_theme(currentTheme);
                }
            }

            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                window.pywebview.api.get_config().then(config => {
                    if (config.follow_sys) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        load_theme(newTheme);
                    }
                });
            });

            // 初始化配置
            window.pywebview.api.get_config().then(updateUIFromConfig);
        });

        async function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            desktop_path = await window.pywebview.api.where_d()
            
            const parts = path.replace(desktop_path,"").split('\\').filter(part => part.length > 0);
            let currentPath = '';
            
            // 添加桌面项
            const rootItem = document.createElement('span');
            rootItem.className = 'breadcrumb-item';
            rootItem.textContent = '桌面';
            rootItem.dataset.path = "\\";
            rootItem.id = "b2d"
            breadcrumb.appendChild(rootItem);
            
            // 添加路径各部分
            parts.forEach((part, index) => {
                currentPath += part+"\\";
                
                // 添加分隔符
                if (index < parts.length - 1) {
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '›';
                    breadcrumb.appendChild(separator);
                }
                
                // 添加路径项
                const item = document.createElement('span');
                item.className = 'breadcrumb-item';
                item.textContent = part;
                item.dataset.path = currentPath;
                breadcrumb.appendChild(item);
            });
        }

        function navigateTo(path) {
            if (path === currentPath) return;
            
            // 添加到历史记录
            pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
            pathHistory.push(path);
            currentHistoryIndex = pathHistory.length - 1;
            
            // 更新当前路径
            currentPath = path;
            updateBreadcrumb(path || '/');
            
            // 加载新路径内容
            push(null,true, path);
        }

        // 绑定面包屑点击事件
        document.getElementById('breadcrumb').addEventListener('click', function(e) {
            if (e.target.classList.contains('breadcrumb-item')) {
                const path = e.target.dataset.path;
                navigateTo(path);
            }
        });

        function navigateBack() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const path = pathHistory[currentHistoryIndex];
                currentPath = path;
                document.getElementById('currentPathDisplay').textContent = path || '/';
                push(null,true, path);
            }
        }

        function navigateForward() {
            if (currentHistoryIndex < pathHistory.length - 1) {
                currentHistoryIndex++;
                const path = pathHistory[currentHistoryIndex];
                currentPath = path;
                document.getElementById('currentPathDisplay').textContent = path || '/';
                push(null,true, path);
            }
        }

        async function loadDirector(path) {
            try {
                const response = await window.pywebview.api.get_inf(path);
                response = response["data"]
                console.log(response);
                if (response && response.data) {
                    return response.data.map(item => ({
                        ico: item.is_dir ? '/resources/folder.png' : getFileIcon(item.name),
                        fileName: item.name,
                        filePath: item.path,
                        fileType: item.is_dir ? '文件夹' : getFileType(item.name),
                        game: item.is_game ? true : undefined
                    }));
                }
                return [];
            } catch (error) {
                console.error('加载目录失败:', error);
                return [];
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            // 可以根据不同文件类型返回不同图标
            return '/resources/file.png';
        }

        // 加载目录内容
        async function loadDirectory(path) {
            try {
                data = await window.pywebview.api.get_inf(path);
                data = data["data"]
                return data;
            } catch (error) {
                console.error('Error loading directory:', error);
                return [];
            }
        }

        // 监听空白区域右键点击（网格视图）
        document.querySelector('.files-grid').addEventListener('contextmenu', function(e) {
            if (e.target === this) {
                e.preventDefault();
                hideContextMenu();
                blankMenu.style.display = 'block';
                blankMenu.style.left = `${e.pageX}px`;
                blankMenu.style.top = `${e.pageY}px`;
            } else if (e.target.classList.contains('file') || e.target.classList.contains('file-name')) {
                const fileElement = e.target.classList.contains('file') ? e.target : e.target.parentElement;
                const fileName = fileElement.querySelector('.file-name').textContent;
                selectedFile = files_data.find(file => file.fileName === fileName);
                
                if (selectedFile) {
                    const openItem = document.getElementById('menuOpen');
                    if (selectedFile.fileType === '文件夹') {
                        openItem.textContent = '打开文件夹';
                    } else {
                        openItem.textContent = '打开文件';
                    }
                    
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    e.preventDefault();
                }
            }
        });

        // 监听空白区域右键点击（列表视图）
        document.querySelector('.files-list').addEventListener('contextmenu', function(e) {
            if (e.target === this) {
                e.preventDefault();
                hideContextMenu();
                blankMenu.style.display = 'block';
                blankMenu.style.left = `${e.pageX}px`;
                blankMenu.style.top = `${e.pageY}px`;
            } else if (e.target.classList.contains('file-list-item') || e.target.classList.contains('file-list-name')) {
                const fileElement = e.target.classList.contains('file-list-item') ? e.target : e.target.parentElement;
                const fileName = fileElement.querySelector('.file-list-name').textContent;
                selectedFile = files_data.find(file => file.fileName === fileName);
                
                if (selectedFile) {
                    const openItem = document.getElementById('menuOpen');
                    if (selectedFile.fileType === '文件夹') {
                        openItem.textContent = '打开文件夹';
                    } else {
                        openItem.textContent = '打开文件';
                    }
                    
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    e.preventDefault();
                }
            }
        });

        // 点击空白处隐藏菜单
        document.addEventListener('click', function() {
            blankMenu.style.display = 'none';
        });

        // 确保右键菜单在两种视图下都能工作
        function hideAllMenus() {
            hideContextMenu();         // 隐藏文件菜单
            blankMenu.style.display = 'none';  // 隐藏空白菜单
        }

        document.addEventListener('click', hideAllMenus);
        // 模拟的put_file函数
        async function put_file() {
            await window.pywebview.api.put_file();
            push(null);
        }

        // 模拟的new_file函数
        async function new_file(fileType) {
            await window.pywebview.api.new_file(fileType);
            push(null); // 刷新界面
        }

        // 粘贴按钮事件
        menuPaste.addEventListener('click',async function() {
            try{
                r = await put_file();
                try{
                    if(r["success"]==false){
                        showError(r["message"]);
                    }
                }catch{}
                blankMenu.style.display = 'none';
            }catch{}
        });

        // 新建按钮事件
        menuNew.addEventListener('click', function() {
            newFileOverlay.style.display = 'flex';
            blankMenu.style.display = 'none';
        });

        // 取消新建
        newFileCancel.addEventListener('click', function() {
            newFileOverlay.style.display = 'none';
        });

        // 确认新建
        newFileConfirm.addEventListener('click',async function() {
            const selectedType = newFileTypeSelect.value;
            if (selectedType) {
                await new_file(selectedType);
                newFileOverlay.style.display = 'none';
                push(null);
            }
        });
        function hideAllMenus() {
            hideContextMenu();         // 隐藏文件菜单
            blankMenu.style.display = 'none';  // 隐藏空白菜单
        }

        document.addEventListener('click', hideAllMenus);

        document.addEventListener('DOMContentLoaded', function() {
            // 更新时间
            updateTime();
            setInterval(updateTime, 1000);
            
            // 右键菜单项事件z
            document.getElementById('menuOpen').addEventListener('click', function() {
                if(selectedFile['game']){
                    open_mhyGame(selectedFile.filePath,selectedFile.game);
                }else{
                    open_file(selectedFile.filePath);
                }
                hideContextMenu();
            });
            
            document.getElementById('menuCopy').addEventListener('click', function() {
                copy_file(selectedFile.filePath);
                hideContextMenu();
            });
            
            document.getElementById('menuRename').addEventListener('click', showRenameDialog);
            document.getElementById('menuDelete').addEventListener('click', showDeleteConfirm);
            
            // 重命名相关事件
            document.getElementById('renameCancel').addEventListener('click', function() {
                if(dealling)return
                dealling = true
                document.getElementById('renameOverlay').style.display = 'none';
                dealling = false
            });
            
            document.getElementById('renameConfirm').addEventListener('click', function() {
                if(dealling)return
                dealling = true
                const newName = document.getElementById('renameInput').value.trim();
                if (newName) {
                    rename_file(selectedFile.filePath, newName);
                    document.getElementById('renameOverlay').style.display = 'none';
                }
                dealing = false
            });
            
            // 删除相关事件
            document.getElementById('deleteCancel').addEventListener('click', function() {
                document.getElementById('deleteConfirm').style.display = 'none';
                dealing = false
            });
            
            document.getElementById('deleteConfirmBtn').addEventListener('click',async function() {
                dealling = true
                var r = await remove_file(selectedFile.filePath);
                if(r["success"]==false){
                    showError(r["message"])
                }
                document.getElementById('deleteConfirm').style.display = 'none';
                dealling = false
            });
            
            // 点击页面其他位置关闭右键菜单
            document.addEventListener('click', hideContextMenu);
            
            // 重命名输入框按回车确认
            document.getElementById('renameInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('renameConfirm').click();
                }
            });
        })
    </script>
    <script>
        function showError(code) {
            // 创建外层提示框
            const errorBox = document.createElement('div');
            errorBox.style.position = 'fixed';
            errorBox.style.top = '-100px';
            errorBox.style.left = '50%';
            errorBox.style.transform = 'translateX(-50%)';
            errorBox.style.padding = '20px 30px';
            errorBox.style.backgroundColor = '#ff4d4d';
            errorBox.style.color = 'white';
            errorBox.style.fontSize = '16px';
            errorBox.style.borderRadius = '12px';
            errorBox.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            errorBox.style.zIndex = '9999';
            errorBox.style.opacity = '0';
            errorBox.style.transition = 'opacity 0.5s ease, top 0.5s ease';
            errorBox.style.textAlign = 'center';

            // 创建文字内容
            const text = document.createElement('div');
            text.textContent = code;
            errorBox.appendChild(text);

            // 添加到 body
            document.body.appendChild(errorBox);

            // 触发动画显示
            setTimeout(() => {
                errorBox.style.top = '20px';
                errorBox.style.opacity = '1';
            }, 100);

            // 5秒后自动消失（淡出）
            setTimeout(() => {
                errorBox.style.opacity = '0';
                errorBox.style.top = '-100px';

                // 完全隐藏后移除元素
                setTimeout(() => {
                    if (errorBox.parentNode) {
                        errorBox.remove();
                    }
                }, 500);
            }, 5000);
        }
        function contains(mainStr, searchStr) {
            const cleanMainStr = mainStr.replace(/[^\w]/g, '');
            const cleanSearchStr = searchStr.replace(/[^\w]/g, '');
            const regex = new RegExp(cleanSearchStr, 'i');
            return regex.test(cleanMainStr);
        }
        async function load_search(){
            const key = document.getElementById("search_input").value
            if(key==""){
                push(files_data)
                return
            }
            py_data = await window.pywebview.api.load_search_index(files_data)
            out_data = []
            for(var i=0;i<files_data.length;i++){
                if(contains(py_data[files_data[i]["fileName"]]["sxpy"],key)==true){
                    out_data.push(files_data[i])
                    continue
                }
                if(contains(py_data[files_data[i]["fileName"]]["py"],key)==true){
                    out_data.push(files_data[i])
                    continue
                }
            }
            push(out_data)
        }
        async function load_theme(theme){
            const theme_inf = {
                "dark":"/theme/dark.css",
                "light":"/theme/light.css",
                "zzz":"/theme/zzz.css"
            }
            document.getElementById("theme_css").href = theme_inf[theme]
        }
        document.addEventListener('keydown', function(event) {
            if (document.activeElement.id !== 'search_input') {
                const searchInput = document.getElementById('search_input');
                if (searchInput) {
                    if (!event.ctrlKey && !event.altKey && !event.metaKey && event.key.length === 1) {
                    searchInput.focus();
                    }
                }
            }
        });
    </script>
    
<script>
    function disableScroll() {
        document.addEventListener('touchmove', preventDefault, { passive: false });
        document.addEventListener('mousewheel', preventDefault, { passive: false });
        document.addEventListener('wheel', preventDefault, { passive: false });
        document.addEventListener('DOMMouseScroll', preventDefault, { passive: false });
    }
    function enableScroll() {
        document.removeEventListener('touchmove', preventDefault, { passive: false });
        document.removeEventListener('mousewheel', preventDefault, { passive: false });
        document.removeEventListener('wheel', preventDefault, { passive: false });
        document.removeEventListener('DOMMouseScroll', preventDefault, { passive: false });
    }
    function preventDefault(e) {
        e.preventDefault();
    }
</script>
    
    <!-- 主题设置面板 -->
    <div class="theme-settings-panel" id="themeSettingsPanel">
        <div class="settings-header">
            <h3>主题设置</h3>
            <button class="close-btn" id="closeThemePanel"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="settings-section">
            <div class="system-theme-toggle">
                <span>跟随系统主题</span>
                <label class="switch">
                    <input type="checkbox" id="followSystemTheme">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
        <div class="settings-section">
            <h4>选择主题</h4>
            <div class="theme-cards">
                <div class="theme-card" data-theme="light">
                    <div class="theme-preview">
                        <img src="/resources/theme_previews/light.png" alt="浅色主题预览">
                    </div>
                    <span>浅色主题</span>
                </div>
                <div class="theme-card" data-theme="dark">
                    <div class="theme-preview">
                        <img src="/resources/theme_previews/dark.png" alt="深色主题预览">
                    </div>
                    <span>深色主题</span>
                </div>
                <div class="theme-card" data-theme="zzz">
                    <div class="theme-preview">
                        <img src="/theme/zzz_bg.png" alt="绝区零主题预览">
                    </div>
                    <span>绝区零主题</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>